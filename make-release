#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Check if the working directory is clean
if ! git diff-index --quiet HEAD --; then
    echo "Working directory is not clean. Please commit or stash your changes."
    exit 1
fi

echo "Pulling latest changes from origin..."
git pull origin main

# --- Version Management ---
# Read the current version from pyproject.toml
CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' pyproject.toml)
echo "Current version: ${CURRENT_VERSION}"

# Increment the patch version number
IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
major=${version_parts[0]}
minor=${version_parts[1]}
patch=${version_parts[2]}
new_patch=$((patch + 1))
NEW_VERSION="${major}.${minor}.${new_patch}"
echo "New version will be: ${NEW_VERSION}"

# Update the version in pyproject.toml using sed
# This is safer than rewriting the whole file
sed -i "s/version = \"${CURRENT_VERSION}\"/version = \"${NEW_VERSION}\"/" pyproject.toml
echo "Updated pyproject.toml to version ${NEW_VERSION}"

# --- Git Tagging and Pushing ---
# Commit the version bump
git add pyproject.toml
git commit -m "chore: bump version to ${NEW_VERSION}"

# Create the new tag
NEW_TAG="v${NEW_VERSION}"
echo "Creating new tag: ${NEW_TAG}"
git tag "${NEW_TAG}"

echo "Pushing commit and new tag to origin..."
git push origin main
git push origin "${NEW_TAG}"

echo "Successfully created and pushed tag ${NEW_TAG}. The release process should now start on GitHub Actions."
